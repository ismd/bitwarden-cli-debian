name: Check Upstream Version

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  check-version:
    name: Check for new Bitwarden CLI release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Check upstream version
        id: check
        run: |
          # Run check script with JSON output
          OUTPUT=$(.packaging/check-upstream-version.sh --json)
          echo "Output: ${OUTPUT}"

          # Parse JSON
          CURRENT=$(echo "${OUTPUT}" | jq -r '.current_version')
          LATEST=$(echo "${OUTPUT}" | jq -r '.latest_version')
          UPDATE_AVAILABLE=$(echo "${OUTPUT}" | jq -r '.update_available')
          LATEST_NAME=$(echo "${OUTPUT}" | jq -r '.latest_name')
          LATEST_URL=$(echo "${OUTPUT}" | jq -r '.latest_url')
          LATEST_DATE=$(echo "${OUTPUT}" | jq -r '.latest_date')

          # Set outputs
          echo "current_version=${CURRENT}" >> $GITHUB_OUTPUT
          echo "latest_version=${LATEST}" >> $GITHUB_OUTPUT
          echo "update_available=${UPDATE_AVAILABLE}" >> $GITHUB_OUTPUT
          echo "latest_name=${LATEST_NAME}" >> $GITHUB_OUTPUT
          echo "latest_url=${LATEST_URL}" >> $GITHUB_OUTPUT
          echo "latest_date=${LATEST_DATE}" >> $GITHUB_OUTPUT

          # Also set as env for later steps
          echo "CURRENT_VERSION=${CURRENT}" >> $GITHUB_ENV
          echo "LATEST_VERSION=${LATEST}" >> $GITHUB_ENV
          echo "UPDATE_AVAILABLE=${UPDATE_AVAILABLE}" >> $GITHUB_ENV
          echo "LATEST_NAME=${LATEST_NAME}" >> $GITHUB_ENV
          echo "LATEST_URL=${LATEST_URL}" >> $GITHUB_ENV

      - name: Check if update PR already exists
        if: steps.check.outputs.update_available == 'true'
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if PR already exists for this version
          PR_EXISTS=$(gh pr list --state open --search "head:upstream-update/${LATEST_VERSION}" --json number --jq 'length')
          echo "pr_exists=${PR_EXISTS}" >> $GITHUB_OUTPUT

          if [ "${PR_EXISTS}" -gt 0 ]; then
            echo "PR already exists for ${LATEST_VERSION}"
            PR_NUMBER=$(gh pr list --state open --search "head:upstream-update/${LATEST_VERSION}" --json number --jq '.[0].number')
            echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          fi

      - name: Trigger update workflow
        if: steps.check.outputs.update_available == 'true' && steps.check-pr.outputs.pr_exists == '0'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'update-upstream.yml',
              ref: 'main',
              inputs: {
                version: '${{ steps.check.outputs.latest_version }}'
              }
            });

            console.log('Triggered update workflow for version: ${{ steps.check.outputs.latest_version }}');

      - name: Create notification issue (optional)
        if: steps.check.outputs.update_available == 'true' && steps.check-pr.outputs.pr_exists == '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Optionally create an issue to notify maintainers
          # Comment this out if you don't want notification issues

          gh issue create \
            --title "New upstream version available: ${LATEST_VERSION}" \
            --body "A new version of Bitwarden CLI has been released.

          **Current version:** ${CURRENT_VERSION}
          **New version:** ${LATEST_VERSION}
          **Release name:** ${LATEST_NAME}
          **Release date:** ${LATEST_DATE}
          **Release URL:** ${LATEST_URL}

          The \`update-upstream\` workflow has been triggered automatically to import the new version and create a pull request.

          ---
          *This issue was created automatically by the \`check-upstream\` workflow.*" \
            --label "upstream-update"

      - name: Summary
        run: |
          echo "## Upstream Version Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Current version:** ${CURRENT_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest version:** ${LATEST_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update available:** ${UPDATE_AVAILABLE}" >> $GITHUB_STEP_SUMMARY

          if [ "${UPDATE_AVAILABLE}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”„ Update workflow has been triggered." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Already up to date." >> $GITHUB_STEP_SUMMARY
          fi
