name: Build and Release Debian Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub release'
        required: false
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:trixie
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies from Debian repos
      run: |
        apt-get update
        apt-get install -y \
          debhelper \
          dpkg-dev \
          lintian \
          nodejs \
          npm \
          git \
          ca-certificates

    - name: Extract package info
      id: package_info
      run: |
        if [[ "${{ github.ref }}" =~ refs/tags/v(.+)-([0-9]+) ]]; then
          # Tag format: v2025.8.0-1
          UPSTREAM_VERSION="${BASH_REMATCH[1]}"
          DEBIAN_REVISION="${BASH_REMATCH[2]}"
        elif [[ "${{ github.ref }}" =~ refs/tags/v(.+) ]]; then
          # Tag format: v2025.8.0 (default to revision 1)
          UPSTREAM_VERSION="${BASH_REMATCH[1]}"
          DEBIAN_REVISION="1"
        else
          # Development build
          UPSTREAM_VERSION="dev-$(date +%Y%m%d)"
          DEBIAN_REVISION="$(git rev-parse --short HEAD)"
        fi

        FULL_VERSION="${UPSTREAM_VERSION}-${DEBIAN_REVISION}"
        PACKAGE_NAME="bitwarden-cli"

        echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
        echo "debian_revision=$DEBIAN_REVISION" >> $GITHUB_OUTPUT
        echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT
        echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        echo "deb_file=${PACKAGE_NAME}_${FULL_VERSION}_amd64.deb" >> $GITHUB_OUTPUT

    - name: Update debian/changelog with version
      run: |
        UPSTREAM_VERSION="${{ steps.package_info.outputs.upstream_version }}"
        DEBIAN_REVISION="${{ steps.package_info.outputs.debian_revision }}"
        FULL_VERSION="${UPSTREAM_VERSION}-${DEBIAN_REVISION}"

        # Update changelog with current version
        cat > debian/changelog << EOF
        bitwarden-cli ($FULL_VERSION) unstable; urgency=medium

          * Build for version $UPSTREAM_VERSION

         -- Vladimir Kosteley <debian@ismd.dev>  $(date -R)
        EOF

    - name: Build package using debuild
      run: |
        # Build using Debian's standard tooling
        dpkg-buildpackage -us -uc -b

    - name: Move .deb file to current directory
      run: |
        mv ../*.deb .

    - name: Validate package
      run: |
        lintian --info *.deb || true

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: debian-package
        path: "*.deb"
        retention-days: 30

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.create_release)
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name || format('v{0}', steps.package_info.outputs.version) }}
        name: Release ${{ steps.package_info.outputs.version }}
        body: |
          ## Bitwarden CLI Debian Package v${{ steps.package_info.outputs.version }}

          ### Installation
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name || format('v{0}', steps.package_info.outputs.version) }}/${{ steps.package_info.outputs.deb_file }}
          sudo dpkg -i ${{ steps.package_info.outputs.deb_file }}
          ```

          ### Usage
          ```bash
          bw --help
          ```

          ### Changes
          - Updated to version ${{ steps.package_info.outputs.version }}
        files: |
          *.deb
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
